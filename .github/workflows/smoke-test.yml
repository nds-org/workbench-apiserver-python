name: Smoke Test

on: 
  # Automatic: Run on pending pull requests
  pull_request:
    branches:
      - main
      - develop

  # Automatic: Run when new commits are pushed to develop or main
  push:
    paths-ignore:
      - '.github/**'
      - '.gitignore'
      - 'Dockerfile'
      - '.dockerignore'
      - 'README.md'
    branches:
      - main
      - develop

  # Manual: Allow user to manually request this via GitHub UI
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.9' 
      
      - name: Install Python dependencies
        run: pip install --user -r requirements.txt
        
      - uses: helm/kind-action@v1
        name: Create kind cluster
        with:
          config: .kind.with.hostpath.yml
          
      - name: Setup environment
        run: |
          cat env/backend.json | sed -e 's#"uri": "mongodb://workbench:workbench@workbench-mongodb-svc.workbench.svc.cluster.local:27017/ndslabs?authSource=admin",#"uri": "mongodb://workbench:workbench@localhost:27017/ndslabs?authSource=admin",#' > env/backend.json
          cat env/backend.json

      - name: Run MongoDB
        uses: addnab/docker-run-action@v3
        with:
          image: mongo
          options: -e MONGO_INITDB_ROOT_USERNAME=workbench -e MONGO_INITDB_ROOT_PASSWORD=workbench -p 27017 -d

      - name: Run Workbench API server
        run: |
          python ./server.py &
          curl --fail --insecure http://localhost:5000/api/v1/version
          curl --fail --insecure http://localhost:5000/backend.json
          curl --fail --insecure http://localhost:5000/frontend.json
        
      - name: "Test Connection - API server -> MongoDB"
        run: |
          curl --fail --insecure http://localhost:5000/api/v1/services
